# PRD: 商品ID 2369901364的ERP数据抓取问题修复

## 1. 背景与问题描述

### 1.1 问题背景
在ai-product-selector3项目中，商品ID 2369901364 (URL: https://www.ozon.ru/product/2369901364) 的ERP数据抓取存在异常。当前抓取结果只能获取到字段标签（如`category: 类目：`, `sku: SKU：`, `brand_name: 品牌：`），但无法获取实际的数据值。

### 1.2 影响范围
该问题影响所有尝试抓取商品ID 2369901364 ERP数据的用户，导致无法获取该商品的关键业务指标信息。

### 1.3 用户价值
修复此问题将使用户能够正常获取商品ID 2369901364的完整ERP数据，提升数据抓取的准确性和完整性。

## 2. 需求分析

### 2.1 功能需求
1. 正确提取商品ID 2369901364的ERP数据字段值
2. 保持对其他商品ERP数据抓取功能的兼容性
3. 提升ERP数据抓取的稳定性和准确性

### 2.2 非功能需求
1. 性能：不影响整体数据抓取性能
2. 兼容性：保持向后兼容
3. 可维护性：代码结构清晰，易于后续维护

## 3. 技术方案

### 3.1 根因分析
通过代码分析，我们发现问题的根本原因包括：
1. 字段提取逻辑无法正确处理商品2369901364的DOM结构
2. 等待机制不够充分，ERP插件可能未完全加载
3. 缺乏有效的内容验证机制
4. 参数传递存在缺陷

### 3.2 解决方案设计

#### 3.2.1 增强字段提取逻辑
在`_extract_field_value`方法中增加第7种提取方法，专门处理商品2369901364的DOM结构：

```python
# 方法7：针对商品2369901364的特殊处理 - 更宽松的匹配
# 尝试在所有文本节点中查找标签和值的组合
text_nodes = container.find_all(string=True)
for i, text_node in enumerate(text_nodes):
    if search_label in str(text_node).strip():
        # 查找下一个文本节点作为可能的值
        if i + 1 < len(text_nodes):
            next_text = str(text_nodes[i + 1]).strip()
            if next_text and self._is_valid_value(next_text):
                self.logger.debug(f"✅ 方法7成功: 标签'{label_text}' -> 值'{next_text}'")
                return next_text
```

#### 3.2.2 改进正则表达式匹配
增强正则表达式的匹配能力，更好地处理空白字符和特殊字符：

```python
# 使用改进的正则表达式提取标签后的值
# 匹配标签后的非空白字符，直到遇到下一个标签或文本末尾
pattern = rf'{re.escape(search_label)}\s*([^\n\r\t]+?)(?=\s*(?:[a-zA-Z\u4e00-\u9fa5]+[：:]|$))'
matches = re.findall(pattern, all_text)
if matches:
    # 取第一个匹配项并清理
    value = matches[0].strip()
    # 进一步清理可能的多余字符
    value = re.sub(r'[\s\u00a0]+', ' ', value)  # 替换不间断空格和其他空白字符
    value = value.strip('：:')  # 移除可能的冒号
```

#### 3.2.3 增加内容验证器
在等待ERP内容加载时增加内容验证器，确保获取到的内容是有效的：

```python
def content_validator(elements):
    """验证ERP内容是否有效"""
    if not elements:
        return False
        
    # 检查元素是否包含足够的文本内容
    for element in elements:
        if hasattr(element, 'get_text'):
            text = element.get_text(strip=True)
            # 如果元素包含足够的文本内容，则认为有效
            if len(text) > 50:  # 至少50个字符
                return True
                
        # 检查元素的子元素
        if hasattr(element, 'find_all'):
            children = element.find_all('span')
            # 如果有多个span子元素，可能包含ERP数据
            if len(children) > 3:
                return True
                
    return False
```

#### 3.2.4 延长等待时间
将等待时间从20秒延长到30秒，确保ERP插件有足够的时间加载：

```python
result = wait_for_content_smart(soup=soup,
                              browser_service=self.browser_service,
                              selectors=self.selectors_config.erp_container_selectors,
                              max_wait_seconds=30,  # 增加等待时间到30秒
                              content_validator=content_validator)
```

#### 3.2.5 修复参数传递问题
修复`scrape`方法中的参数传递问题，确保`soup`对象能够正确传递：

```python
try:
    static_soup = None
    if context and 'soup' in context:
        static_soup = context.get('soup')
    elif kwargs and 'soup' in kwargs:
        static_soup = kwargs.get('soup')
```

## 4. 实施计划

### 4.1 开发任务
1. 修改`common/scrapers/erp_plugin_scraper.py`文件，增强字段提取逻辑
2. 增加内容验证器
3. 延长等待时间
4. 修复参数传递问题

### 4.2 测试计划
1. 单元测试：验证增强的字段提取逻辑
2. 集成测试：测试商品2369901364的ERP数据抓取
3. 回归测试：确保其他商品的ERP数据抓取不受影响

### 4.3 部署计划
1. 代码审查
2. 合并到主分支
3. 部署到测试环境
4. 验证修复效果
5. 部署到生产环境

## 5. 风险评估与应对

### 5.1 技术风险
- **风险**: 增强的提取逻辑可能影响其他商品的数据抓取
- **应对**: 进行全面的回归测试，确保兼容性

### 5.2 性能风险
- **风险**: 延长等待时间可能影响整体性能
- **应对**: 监控系统性能指标，必要时进行优化

## 6. 验收标准

### 6.1 功能验收标准
1. 商品ID 2369901364的ERP数据能够正确提取
2. 所有ERP数据字段都有对应的值
3. 不影响其他商品的ERP数据抓取

### 6.2 性能验收标准
1. 数据抓取时间在可接受范围内
2. 系统资源占用无明显增加

## 7. 附录

### 7.1 相关文件
- `common/scrapers/erp_plugin_scraper.py`: 主要修改文件
- `common/utils/wait_utils.py`: 等待工具文件
- `common/config/erp_selectors_config.py`: ERP选择器配置文件

### 7.2 测试用例
- `tests/rpa/test_erp_2369901364_fix.py`: 基础功能测试
- `tests/rpa/test_erp_2369901364_real_scenario.py`: 真实场景测试
