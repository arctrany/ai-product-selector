# 1688货源匹配模块技术方案

## 1. 模块概述
1688货源匹配模块是选品系统中的核心组件，负责根据商品信息匹配1688平台的相似货源。该模块接收上游商品采集和价格获取模块的数据，输出符合条件的货源信息供下游利润计算器模块使用。

### 1.1 模块定位
- **上游模块**: 商品采集和价格获取
- **下游模块**: 利润计算器
- **核心功能**: 图片相似度匹配 + 商品信息相似度评估
- **最终输出**: 符合条件的全部货源信息

## 2. 环境配置

### 2.1 环境变量配置
支持跨平台环境变量设置（macOS、Windows、Linux）：

```bash
# 必需环境变量
export XP_ATK="your_1688_access_token"
export QWEN_API_KEY="your_qwen_api_key"

# 可选环境变量（不存在时使用默认值）
export QWEN_BASE_URL="https://dashscope.aliyuncs.com/compatible-mode/v1"  # 默认值
export QWEN_MODEL="qwen-turbo"  # 默认值
```

### 2.2 CLI参数重构
```bash
# 新的CLI参数结构
python source_matcher.py --data input_data.json --config system_config.json --dryrun

# --data: 用户输入参数（表单数据）
# --config: 系统配置参数
# --dryrun: 干运行模式（可选）
```

### 2.3 系统配置参数
`--config` 系统配置文件：

```json
{
  "source_matching": {
    "image_weight": 0.5,
    "timeout_seconds": 20,
    "max_results": 10,
    "api_retry_count": 2,
    "api_rate_limit_seconds": 1
  }
}
```

### 2.4 用户输入参数
`--data` 用户数据文件：

```json
{
  "good_shop_file": "/Users/haowu/IdeaProjects/ai-product-selector3/docs/good_shops.xlsx",
  "item_collect_file": "/Users/haowu/IdeaProjects/ai-product-selector3/docs/goods.xlsx",
  "margin_calculator": "/Users/haowu/Downloads/profits.xlsx",
  "item_similarity": "0.6",
  "margin": 0.15,
  "item_created_days": 150,
  "follow_buy_cnt": 37,
  "max_monthly_sold": 0,
  "monthly_sold_min": 100,
  "item_min_weight": 0,
  "item_max_weight": 1000,
  "g01_item_min_price": 0,
  "g01_item_max_price": 1000,
  "max_products_per_store": 50,
  "output_format": "xlsx",
  "output_path": "/Users/haowu/IdeaProjects/ai-product-selector3/output",
  "remember_settings": true
}
```

## 3. 图片相似度算法

### 3.1 算法实现
基于 `apps/xuanping/utils/image_similarity.py`，优先使用本地算法，不依赖大语言模型：

#### 3.1.1 传统算法组合（优先使用）
- **感知哈希 (pHash)**: 计算图片的感知哈希值，通过汉明距离比较
- **结构相似度 (SSIM)**: 基于亮度、对比度和结构的图片质量评估
- **ORB特征匹配**: 检测关键点并进行特征匹配

#### 3.1.2 深度学习算法（可选）
- **CLIP语义相似度**: 使用OpenAI CLIP模型进行语义级图片比较
- **模型**: `openai/clip-vit-base-patch32`
- **设备支持**: 自动检测GPU/CPU

#### 3.1.3 综合评分策略
```python
# 优先使用传统算法组合
fast_score = 0.6 * hash_similarity + 0.4 * ssim_similarity

# 如果CLIP可用且结果差异较大时使用
if clip_available and abs(fast_score - clip_score) > 0.25:
    semantic_score = 0.4 * fast_score + 0.4 * clip_score + 0.2 * orb_score
else:
    semantic_score = fast_score
```

## 4. 1688 API集成

### 4.1 API接口信息
- **接口**: 1688相似商品搜索API
- **文档**: https://open.1688.com/api/apidocdetail.htm?spm=1688open.solution-detail.0.0.65f12cce1F9PVW&id=com.alibaba.linkplus%3Aalibaba.cross.similar.offer.search-1&aopApiCategory=category_new
- **签名文档**: https://open.1688.com/doc/signature.htm?spm=1688open.api-detail.0.0.33fd55ed8CxNH2

### 4.2 请求参数
```json
{
  "imageUrl": "商品图片URL",
  "access_token": "从环境变量XP_ATK获取",
  "_aop_signature": "按签名规则生成",
  "pageSize": 10,
  "currentPage": 1
}
```

### 4.3 API限流与重试策略
- **调用频率**: 最多1秒一次
- **重试策略**: 失败时最多重试2次，不降级
- **超时控制**: 整个匹配流程超时20秒

### 4.4 分页处理
- 获取第一页结果，最多10个商品
- 按相似度排序后进行后续处理

## 5. 商品信息相似度评估

### 5.1 Qwen大语言模型集成
- **模型**: 通过OpenAI兼容接口接入Qwen
- **接入方式**: 使用OpenAI SDK，配置自定义base_url

```python
import os
from openai import OpenAI

# 环境变量配置，不存在时使用默认值
QWEN_BASE_URL = os.getenv("QWEN_BASE_URL", "https://dashscope.aliyuncs.com/compatible-mode/v1")
QWEN_MODEL = os.getenv("QWEN_MODEL", "qwen-turbo")

client = OpenAI(
    api_key=os.getenv("QWEN_API_KEY"),
    base_url=QWEN_BASE_URL
)
```

### 5.2 Prompt模板设计
```python
PRODUCT_SIMILARITY_PROMPT = """
你是一位专业的商品鉴定专家，需要评估两个商品的相似度。

请根据以下商品信息，判断它们是否属于同一类商品，并给出0-1之间的相似度评分：
- 1.0分：完全相同的商品（同款同型号）
- 0.8-0.9分：同类商品的不同款式或颜色
- 0.6-0.7分：同大类但不同子类的商品
- 0.4-0.5分：相关但不同类的商品
- 0.0-0.3分：完全不相关的商品

商品A信息：
标题：{title_a}
价格：{price_a}
分类：{category_a}
描述：{description_a}

商品B信息：
标题：{title_b}
价格：{price_b}
分类：{category_b}
描述：{description_b}

请直接返回一个0-1之间的数字作为相似度评分，请在用不到100字解释为什么。
"""
```

### 5.3 批量处理机制
为提高效率，设计批量AI评估：

```python
def batch_evaluate_similarity(product_pairs: List[Tuple], batch_size: int = 5):
    """
    批量评估商品相似度
    
    Args:
        product_pairs: 商品对列表
        batch_size: 批量大小，默认5个
    """
    results = []
    for i in range(0, len(product_pairs), batch_size):
        batch = product_pairs[i:i+batch_size]
        batch_prompt = create_batch_prompt(batch)
        response = client.chat.completions.create(
            model=QWEN_MODEL,
            messages=[{"role": "user", "content": batch_prompt}]
        )
        batch_results = parse_batch_response(response.choices[0].message.content)
        results.extend(batch_results)
    return results
```

### 5.4 AI日志记录
创建专门的AI输入输出日志文件：

```python
# logs/ai_evaluation.log
2024-11-06 21:15:01 [AI_INPUT] Product A: 手机壳iPhone15, Product B: 苹果15手机保护套
2024-11-06 21:15:02 [AI_OUTPUT] Similarity Score: 0.85
2024-11-06 21:15:02 [AI_METRICS] Response Time: 1.2s, Token Usage: 150
```

## 6. 综合相似度计算

### 6.1 权重配置
```json
{
  "similarity_weights": {
    "image_weight": 0.5,
    "product_info_weight": 0.5
  }
}
```

### 6.2 综合评分公式
```python
def calculate_comprehensive_similarity(image_score: float, ai_score: float, weight: float = 0.5) -> float:
    """
    计算综合相似度
    
    Args:
        image_score: 图片相似度 (0-1)
        ai_score: AI商品信息相似度 (0-1)
        weight: 图片权重，默认0.5
    
    Returns:
        综合相似度分数 (0-1)
    """
    return image_score * weight + ai_score * (1 - weight)
```

## 7. 过滤策略

### 7.1 图片相似度预过滤
```python
# 基于用户设定的阈值进行预过滤
image_threshold = user_data.item_similarity_threshold * system_config.image_weight
filtered_products = []

for product in api_results:
    if product.image_score >= image_threshold:
        filtered_products.append(product)
    else:
        logger.info(f"商品 {product.offer_id} 被过滤: 图片相似度 {product.image_score} < {image_threshold}")
```

### 7.2 综合相似度最终过滤
```python
# 综合相似度最终过滤
final_matches = []

for product in evaluated_products:
    if product.comprehensive_score >= user_data.item_similarity_threshold:
        final_matches.append(product)
    else:
        logger.info(f"商品 {product.offer_id} 被过滤: 综合相似度 {product.comprehensive_score} < {user_data.item_similarity_threshold}")
```

## 8. 完整匹配流程

### 8.1 主流程
```python
async def match_1688_source(user_data: UserInputData, system_config: SystemConfig) -> SourceMatchResult:
    """
    完整的1688货源匹配流程
    """
    try:
        # 1. 调用1688 API获取相似商品
        api_results = await call_1688_api(user_data.product_info.image_url)
        
        # 2. 图片相似度计算和预过滤
        image_filtered = await calculate_image_similarities(
            user_data.product_info.image_url, api_results
        )
        
        # 3. AI商品信息相似度评估（DryRun模式下跳过）
        if not system_config.dryrun:
            ai_evaluated = await batch_ai_evaluation(user_data.product_info, image_filtered)
        else:
            ai_evaluated = image_filtered  # DryRun模式使用默认相似度
        
        # 4. 综合相似度计算和过滤
        final_matches = filter_by_comprehensive_similarity(ai_evaluated, user_data)
        
        # 5. 返回所有符合条件的货源信息
        return SourceMatchResult(
            success=True, 
            matches=final_matches,
            total_found=len(api_results),
            filtered_count=len(final_matches)
        )
            
    except Exception as e:
        logger.error(f"货源匹配失败: {e}")
        return SourceMatchResult(success=False, reason=str(e))
```

### 8.2 DryRun模式支持
在DryRun模式下：
- 执行所有抓取和计算逻辑
- 不调用AI模型，使用默认相似度0.5
- 不调用1688真实接口，输出调用参数
- 记录所有处理过程到日志

## 9. 数据结构定义

### 9.1 货源匹配结果
```python
@dataclass
class SourceMatchResult:
    success: bool
    matches: List['SourceMatch'] = None  # 所有符合条件的货源
    total_found: int = 0                 # API返回的总数量
    filtered_count: int = 0              # 过滤后的数量
    reason: Optional[str] = None
    processing_time: float = 0.0
    
@dataclass 
class SourceMatch:
    source_info: Dict[str, Any]      # 1688货源信息
    image_similarity: float          # 图片相似度
    ai_similarity: float            # AI商品信息相似度
    comprehensive_score: float       # 综合相似度
```

### 9.2 1688货源信息
```python
@dataclass
class Source1688Info:
    offer_id: str                   # 商品ID
    subject: str                    # 商品标题
    quantity_begin: int             # 起订量
    unit: str                      # 单位
    old_price: int                 # 价格（分）
    image_url: str                 # 图片URL
    province: str                  # 省份
    city: str                      # 城市
    supply_amount: int             # 供应量
    category_id: str               # 分类ID
```

## 10. 异常处理与监控

### 10.1 异常处理策略
- **API调用失败**: 重试2次后记录错误，不降级
- **图片加载失败**: 跳过该商品，继续处理其他商品，记录过滤原因
- **AI评估超时**: DryRun模式下跳过，正常模式使用默认相似度0.5
- **环境变量缺失**: 抛出配置错误，停止处理

### 10.2 性能监控
```python
# 记录关键性能指标
performance_metrics = {
    "api_call_time": 2.3,
    "image_similarity_time": 1.5, 
    "ai_evaluation_time": 3.2,
    "total_processing_time": 7.0,
    "success_rate": 0.85,
    "filtered_rate": 0.6
}
```