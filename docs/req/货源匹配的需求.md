# 货源匹配系统需求文档

## 1. 概述
实现商品与1688货源的智能匹配系统，通过图片相似度和商品信息相似度的综合评分，找到最佳货源。

## 2. 配置参数
- **相似度阈值**: `item_similarity` (0-1) - 从 `config.json` 获取
- **利润阈值**: `margin` - 从 `config.json` 获取
- **访问令牌**: `access_token` - 从环境变量获取（支持Windows和macOS）

## 3. 核心流程

### 3.1 货源获取
- **接口**: 1688相似商品搜索API
- **文档**: https://open.1688.com/api/apidocdetail.htm?spm=1688open.solution-detail.0.0.65f12cce1F9PVW&id=com.alibaba.linkplus%3Aalibaba.cross.similar.offer.search-1&aopApiCategory=category_new
- **必需参数**: `imageUrl`（商品图片URL）
- **系统参数**:
    - `access_token`：从环境变量获取
    - `_aop_signature`：按照签名规则生成
- **签名生成**: https://open.1688.com/doc/signature.htm?spm=1688open.api-detail.0.0.33fd55ed8CxNH2

### 3.2 相似度计算算法
**综合相似度公式**: `f(x) = 图片相似度 × y + 商详相似度 × (1-y)`
- `y`: 加权值 (0 < y < 1)
- **匹配条件**: `f(x) >= item_similarity`

#### 3.2.1 图片相似度计算
1. **数据源**: 1688API返回的分页结果（最多10个商品）
2. **算法**: 使用本地图片相似度算法（参考 `image_similarity.py`）
3. **评分**: 0-1分，1分为完全相似
4. **过滤阈值**: `g(x) = item_similarity × y`
5. **处理流程**:
    - 计算所有1688商品图片相似度
    - 按相似度降序排序
    - 过滤掉低于 `g(x)` 的商品
    - 将通过筛选的商品进入下一步

#### 3.2.2 商品信息相似度计算
- **方法**: 大语言模型评估
- **角色设定**: 商品鉴定专家
- **评分标准**:
    - 100%相似 = 1.0分
    - 50%相似 = 0.5分
- **判断依据**: 商品是否属于同一商品类型

### 3.3 匹配结果处理
- **成功条件**: `f(x) >= item_similarity`
- **失败处理**: 如无匹配商品，跳过步骤4和5，标记为"无匹配货源"

## 4. 货源信息提取
成功匹配后提取以下信息：

```json
{
  "offerId": "439143824",
  "subject": "手机壳多色可选防摔", 
  "quantityBegin": 3,
  "unit": "个、件",
  "oldPrice": 628,
  "imageUrl": "https://xxx/xxx.png",
  "province": "浙江",
  "city": "杭州市", 
  "supplyAmount": 2000,
  "categoryId": "xx"
}
```

## 5. 进入下一步利润验证
- **计算要素**: 将成本价格和其它计算因素一起作为输入给profit_evaluator，参考 profit_evaluator.py
- **验证条件**: 参考 profit_evaluator.py
- **最终结果**: 参考 profit_evaluator.py

## 6. 异常处理
- 无匹配货源时，停止后续处理流程
- API调用失败时的重试机制
- 环境变量缺失时的错误提示