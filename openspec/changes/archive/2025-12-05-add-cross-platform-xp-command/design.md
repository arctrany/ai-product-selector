## Context

当前系统提供了 `xp` 脚本作为 CLI 入口，但在跨平台使用和依赖管理方面存在以下问题：
1. Linux/macOS 需要手动添加执行权限
2. Windows 需要使用不同的脚本（xp.bat 或 xp.ps1）
3. 用户需要手动安装依赖（`pip install -r requirements.txt`）
4. Playwright 浏览器驱动需要单独安装

这些问题增加了新用户的使用门槛，影响了开发体验。

## Goals / Non-Goals

### Goals
- 提供跨平台统一的命令接口（所有平台都使用 `xp`）
- 首次运行时自动检测并安装缺失依赖
- 提供清晰的错误提示和解决建议
- 保持向后兼容性，不影响现有用户

### Non-Goals
- 不强制使用虚拟环境（用户可以选择使用或不使用）
- 不修改现有的打包流程（PyInstaller 打包保持不变）
- 不改变核心 CLI 功能（只增强入口脚本）

## Decisions

### Decision 1: 依赖检测策略
**选择**: 在脚本入口处进行轻量级检测，而不是在每次运行时都检测

**理由**:
- 首次运行后，依赖通常不会变化
- 减少每次运行的启动时间
- 可以通过环境变量跳过检测

**实现**:
- 检测已安装的包（通过 `pip list` 或 `import` 尝试）
- 如果缺失，提示用户并自动安装
- 使用缓存机制避免重复检测

### Decision 2: 跨平台脚本组织
**选择**: 保持平台特定的脚本文件（xp, xp.bat），但统一接口

**理由**:
- Windows 批处理文件和 Unix shell 脚本语法差异大
- 保持现有文件结构，减少破坏性变更
- 每个平台使用最适合的脚本类型

**实现**:
- Linux/macOS: 改进 `xp` shell 脚本
- Windows: 改进 `xp.bat` 批处理文件
- 统一命令名称：所有平台都叫 `xp`（Windows 用户运行 `xp.bat`）

### Decision 3: 依赖安装方式
**选择**: 使用 `pip install --user` 或虚拟环境，避免全局污染

**理由**:
- 避免需要管理员/root 权限
- 减少与系统 Python 包的冲突
- 提供更好的隔离性

**实现**:
- 优先检测是否在虚拟环境中
- 如果在虚拟环境中，直接安装到虚拟环境
- 如果不在虚拟环境中，使用 `--user` 标志安装到用户目录
- 提供提示建议用户使用虚拟环境

### Decision 4: 错误处理策略
**选择**: 提供友好的错误消息和解决建议，而不是静默失败

**理由**:
- 帮助用户快速定位和解决问题
- 提升用户体验
- 减少支持请求

**实现**:
- 检测常见错误（网络失败、权限不足、Python 版本不兼容等）
- 为每种错误提供具体的解决建议
- 提供跳过依赖检查的选项（环境变量）

## Risks / Trade-offs

### Risk 1: 网络依赖
**风险**: 依赖安装需要网络连接，离线环境无法使用
**缓解**: 
- 检测网络连接，如果失败提供清晰的错误提示
- 允许用户通过环境变量跳过依赖检查
- 提供离线安装的文档说明

### Risk 2: 权限问题
**风险**: 某些系统可能需要管理员权限安装包
**缓解**:
- 优先使用 `--user` 安装，避免需要管理员权限
- 检测权限错误并提供解决建议
- 支持虚拟环境，完全避免权限问题

### Risk 3: 依赖冲突
**风险**: 用户环境中已有冲突的包版本
**缓解**:
- 使用版本范围（requirements.txt 中的 `>=`）而不是固定版本
- 检测冲突并提供警告
- 建议使用虚拟环境隔离

### Risk 4: 跨平台兼容性
**风险**: 不同平台的脚本行为可能不一致
**缓解**:
- 为每个平台编写专门的脚本
- 进行跨平台测试
- 使用统一的依赖检测模块（Python 代码）

## Migration Plan

### 阶段 1: 开发依赖检测模块
- 创建 `cli/dependency_checker.py`
- 实现所有检测和安装函数
- 添加单元测试

### 阶段 2: 增强平台脚本
- 修改 `xp` (Linux/macOS)
- 修改 `xp.bat` (Windows)
- 集成依赖检测模块

### 阶段 3: 测试和验证
- 跨平台测试
- 错误场景测试
- 向后兼容性验证

### 阶段 4: 文档和发布
- 更新文档
- 发布变更

## Open Questions

1. **是否需要支持自动创建虚拟环境？**
   - 当前决定：不自动创建，但提供提示建议用户使用
   - 如果用户反馈需要，可以在后续版本中添加

2. **依赖检测的频率？**
   - 当前决定：每次运行都检测（但使用缓存）
   - 如果性能成为问题，可以考虑只在首次运行时检测

3. **是否需要支持依赖更新？**
   - 当前决定：只检测缺失的依赖，不更新已安装的依赖
   - 用户可以通过 `pip install -r requirements.txt --upgrade` 手动更新

