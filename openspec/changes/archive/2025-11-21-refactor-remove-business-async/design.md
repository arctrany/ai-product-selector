# 业务层异步移除架构设计

## 上下文

当前业务层大量使用异步机制，通过 `BaseScraper.run_async()` 进行异步同步包装。这种混合架构导致：
- SeerfarScraper 销售额数据抓取失败（`.store-total-revenue` 选择器找不到）
- 复杂的事件循环处理与 browser_service 同步方法产生冲突
- 异步/同步混合调用的 timing 问题影响页面元素查找

## 目标 / 非目标

### 目标
- **完全同步化**：业务层不再使用 async/await
- **移除 run_async**：完全移除 run_async 方法及其依赖
- **功能保持**：重构后功能必须完全正常
- **性能优化**：避免同步阻塞，确保合理的超时处理

### 非目标
- 不修改 browser_service 底层的异步实现
- 不影响 rpa 层的异步架构
- 不改变对外 API 接口

## 技术决策

### 决策1：采用完全同步的业务层架构

**选择**：将所有业务层 scraper 类改为完全同步实现

**理由**：
- browser_service 已提供完善的同步方法（`*_sync`）
- 消除异步/同步混合导致的复杂性
- 简化调用链，提高代码可维护性
- 解决当前的元素查找失效问题

**替代方案**：保持异步但修复 run_async 方法
- **拒绝理由**：run_async 的复杂事件循环处理本身就是问题根源

### 决策2：渐进式重构策略

**选择**：以 SeerfarScraper 为试点，逐步重构其他 scraper

**理由**：
- 降低重构风险，便于问题定位
- SeerfarScraper 是当前出现问题的核心类
- 验证重构方案的可行性

**实施步骤**：
1. BaseScraper 核心重构
2. SeerfarScraper 试点重构
3. 其他 scraper 类重构

### 决策3：同步超时处理机制

**选择**：为不同类型操作设定分层超时机制

**超时配置**：
- **页面导航**：10-30秒（根据网络条件）
- **元素查找**：5-10秒（快速失败）
- **数据抓取**：15-60秒（根据数据量）
- **整体任务**：5-10分钟（防止无限等待）

**实现方式**：
```python
import time

def extract_sales_data(self, timeout=30):
    """同步提取销售数据，带超时控制"""
    start_time = time.time()
    try:
        # 直接调用 browser_service 同步方法
        text = self.browser_service.text_content_sync(".store-total-revenue", timeout=5000)
        return self._parse_sales_amount(text)
    except Exception as e:
        if time.time() - start_time > timeout:
            raise TimeoutError(f"数据抓取超时 ({timeout}s)")
        raise e
```

### 决策4：错误处理和重试机制

**选择**：实现统一的错误处理和智能重试

**重试策略**：
- **网络相关错误**：最多重试3次，指数退避
- **元素查找失败**：等待1-2秒后重试，最多2次
- **数据解析错误**：不重试，直接返回失败

**错误分类**：
- 可恢复错误：网络超时、临时元素不可见
- 不可恢复错误：选择器错误、数据格式错误

## 风险评估与缓解

### 风险1：同步阻塞影响用户体验

**缓解措施**：
- 合理设置超时时间
- 添加进度提示和日志
- 支持任务取消机制

### 风险2：重构引入新的功能缺陷

**缓解措施**：
- 充分的单元测试和集成测试
- 渐进式重构，每个阶段都验证
- 保留原有异步版本作为对照

### 风险3：性能回退

**缓解措施**：
- 对比重构前后的性能指标
- 优化同步调用的等待策略
- 监控实际使用中的性能表现

## 迁移计划

### 阶段1：BaseScraper 重构（1-2天）
- 移除 run_async 方法
- 重构 scrape_page_data 为同步
- 更新测试用例

### 阶段2：SeerfarScraper 试点（2-3天）
- 重构所有异步方法
- 验证功能完整性
- 性能对比测试

### 阶段3：其他 Scraper 重构（3-5天）
- 应用验证的重构模式
- 批量处理其他 scraper 类
- 全面回归测试

### 阶段4：清理和优化（1天）
- 移除未使用代码
- 文档更新
- 最终验证

## 回滚计划

如果重构出现严重问题：
1. 保留原有异步实现的备份
2. 可以快速回滚到重构前版本
3. 分析问题原因，调整重构策略

## 验证标准

**功能验证**：
- SeerfarScraper 能成功抓取 `.store-total-revenue` 数据
- 所有现有功能测试用例通过
- 端到端测试场景验证

**集成测试验证**：
- 执行集成测试命令必须成功：
  ```bash
  ./xp start --dryrun --select-shops --data /Users/haowu/IdeaProjects/ai-product-selector3/tests/test_data/test_user_data.json
  ```
- dryrun 模式正常启动无异常
- 商铺选择流程完整执行
- 数据抓取功能正常工作
- 整个流程端到端运行完成

**性能验证**：
- 数据抓取时间不超过重构前的120%
- 内存使用无显著增加
- 错误率不高于重构前
- 集成测试执行时间在可接受范围

**代码质量**：
- 代码覆盖率保持或提升
- Lint 检查全部通过
- 代码复杂度降低
- 无异步相关遗留代码
