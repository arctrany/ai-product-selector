# Change: 添加跟卖商品详情自动抓取功能

## Why

### 业务痛点
当前系统在抓取 OZON 商品信息时，虽然能够识别出有更低价格的跟卖店铺（`has_better_price=True`），但无法自动获取这些跟卖商品的详细信息（如采购价、物流成本、ERP数据等）。这导致用户必须手动点击进入跟卖店铺查看商品详情，严重降低了选品效率。

### 业务价值
- **提高效率**: 自动化抓取跟卖商品详情，节省50%以上的人工操作时间
- **决策支持**: 提供原商品和跟卖商品的完整对比数据，支持更精准的利润分析
- **竞争洞察**: 深入了解竞争对手的定价策略和成本结构

### 典型场景
商家在 OZON 平台发现一款有利润潜力的商品，系统检测到有5个跟卖店铺，其中第一个店铺的价格比原商品低20%。商家需要：
1. 查看该跟卖店铺的商品详情
2. 获取采购价和物流成本
3. 计算该跟卖商品的实际利润
4. 对比原商品和跟卖商品的盈利能力

## What Changes

### 功能变更
- ✅ **自动点击跟卖店铺**: 当检测到更优价格时，自动点击第一个跟卖店铺链接
- ✅ **递归抓取详情**: 进入跟卖商品页面后，自动执行完整的商品信息抓取
- ✅ **数据结构扩展**: 在返回结果中新增 `first_competitor_details` 字段，包含跟卖商品的完整信息
- ✅ **product_id 字段**: 为原商品和跟卖商品都添加唯一标识符
- ✅ **递归终止控制**: 通过参数严格控制递归深度，防止无限循环

### 技术实现
- **递归调用方案**: 在 `scrape()` 方法内部条件性递归调用自身
- **终止条件**: 
  - 参数控制: `_recursion_depth` ≤ 1
  - 业务控制: `include_competitors=False` 时不再递归
- **浏览器管理**: scrape() 内部总是执行 navigate，确保状态一致性
- **错误处理**: 递归失败不影响主流程，降级返回原商品数据

### 数据结构变更
```python
# 变更前
{
    'product_url': 'https://www.ozon.ru/product/...',
    'price_data': {...},
    'erp_data': {...},
    'competitors': [...],
    'has_better_price': True
}

# 变更后
{
    'product_id': '1234567',  # 新增
    'product_url': 'https://www.ozon.ru/product/...',
    'price_data': {...},
    'erp_data': {...},
    'competitors': [...],
    'has_better_price': True,
    'first_competitor_details': {  # 新增
        'product_id': '7654321',
        'product_url': 'https://www.ozon.ru/seller/...',
        'price_data': {...},
        'erp_data': {...}
    }
}
```

### 破坏性变更
**无破坏性变更** - 新增的参数和字段都是可选的，不影响现有调用方式。

## Impact

### 影响的 Specs
- **ozon-scraper**: 核心变更，新增递归抓取逻辑和数据字段

### 影响的代码文件
- `common/scrapers/ozon_scraper.py` - 新增递归逻辑和辅助方法
- `common/models.py` - 扩展数据模型，添加 `product_id` 和 `first_competitor_details`
- `tests/test_ozon_scraper_method.py` - 新增递归场景测试用例

### 性能影响
- **时间开销**: 当 `has_better_price=True` 时，单个商品的抓取时间增加 100-140%（从 5-10秒 增加到 13-24秒）
- **资源消耗**: 额外的页面导航和元素定位操作，内存占用增加约 20-30MB
- **影响评估**: 由于只有部分商品会触发递归（预计 < 30%），总体性能影响可接受

### 风险评估
1. **递归风险**: 通过双重保险（递归深度 + 参数控制）降低无限循环风险 - **风险等级: 低**
2. **浏览器状态**: 点击跳转可能失败或超时 - **风险等级: 中**，已有降级策略
3. **数据一致性**: 两次抓取的时间间隔可能导致数据不一致 - **风险等级: 低**，影响可忽略

## Migration Plan

### 向后兼容性
✅ **完全向后兼容** - 所有新增参数都有默认值，现有代码无需修改即可运行。

### 可选迁移
如果调用方希望使用新功能，需要：
1. 更新数据模型以支持 `first_competitor_details` 字段
2. 更新业务逻辑以处理跟卖商品详情数据
3. （可选）调整参数控制递归行为

## Success Metrics

- ✅ 单元测试覆盖率 ≥ 90%
- ✅ 递归场景功能测试通过
- ✅ 性能测试：单商品抓取时间 < 30秒
- ✅ 错误率 < 5%（跟卖详情抓取失败时降级成功）
- ✅ 所有现有测试用例通过，无回归问题
