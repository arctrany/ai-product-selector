## Context

当前系统在选品流程中缺少货源匹配环节。根据需求文档，需要实现：
1. 调用1688 API根据商品图片搜索相似货源
2. 使用图片相似度算法过滤明显不匹配的商品
3. 使用AI大语言模型评估商品信息相似度
4. 综合评分找到最佳匹配货源
5. 提取货源价格信息，传递给利润评估器

系统已有图片相似度实现（`utils/image_similarity.py`），需要集成1688 API和AI评估功能。

## Goals / Non-Goals

### Goals
- 实现1688 API图搜功能，获取相似商品列表
- 集成现有图片相似度算法，进行初步过滤
- 实现AI商品信息相似度评估，提高匹配准确性
- 综合图片和AI相似度，找到最佳匹配货源
- 与利润评估器集成，传递货源价格信息
- 支持DryRun模式，便于测试和调试

### Non-Goals
- 不实现1688 API的完整功能（只实现相似商品搜索）
- 不修改现有图片相似度算法实现（只集成使用）
- 不实现货源价格谈判或下单功能（只获取价格信息）
- 不实现多平台货源匹配（只支持1688）

## Decisions

### Decision 1: API抓取器位置
**选择**: 在 `common/scrapers/api_scraper.py` 中实现1688 API调用

**理由**:
- 符合现有架构模式（scrapers目录存放所有抓取器）
- 与其他scraper（ozon_scraper、seerfar_scraper）保持一致
- 便于复用和维护

**实现**:
- 创建 `Alibaba1688Scraper` 类，继承或实现统一的接口
- 实现1688 API签名生成逻辑
- 实现API调用和响应解析

### Decision 2: AI模块独立性
**选择**: 创建独立的 `ai_similarity_evaluator.py` 模块

**理由**:
- AI评估是独立的功能模块，可以单独测试和维护
- 便于后续扩展（支持其他AI模型或评估方式）
- 符合单一职责原则

**实现**:
- 创建 `AISimilarityEvaluator` 类
- 使用OpenAI兼容接口接入Qwen模型
- 提供清晰的接口，便于集成

### Decision 3: 图片相似度集成方式
**选择**: 直接使用现有的 `ProductImageSimilarity` 类

**理由**:
- 已有完整的图片相似度实现，无需重复开发
- 支持多种算法（哈希、SSIM、ORB、CLIP）
- 性能已优化，支持缓存

**实现**:
- 在 `SourceMatcher` 中实例化 `ProductImageSimilarity`
- 调用 `calculate_similarity()` 方法计算相似度
- 使用 `method='auto'` 自动选择最佳算法

### Decision 4: 综合相似度权重配置
**选择**: 使用配置文件中的 `image_weight` 参数（默认0.5）

**理由**:
- 不同商品类型可能需要不同的权重
- 允许用户根据实际效果调整权重
- 提供默认值，降低使用门槛

**实现**:
- 公式：`comprehensive_score = image_score × image_weight + ai_score × (1 - image_weight)`
- 默认权重：0.5（图片和AI各占50%）
- 支持通过配置文件调整

### Decision 5: 过滤策略
**选择**: 两阶段过滤（图片相似度预过滤 + 综合相似度最终过滤）

**理由**:
- 图片相似度计算快，可以快速过滤明显不匹配的商品
- 减少AI评估的调用次数，降低成本
- 提高整体匹配效率

**实现**:
- 第一阶段：图片相似度 >= `item_similarity × image_weight`，过滤掉明显不匹配的商品
- 第二阶段：综合相似度 >= `item_similarity`，最终确定匹配商品

### Decision 6: AI评估降级策略
**选择**: AI评估失败时使用默认相似度0.5，不中断流程

**理由**:
- 保证系统可用性，即使AI服务不可用也能继续工作
- 默认值0.5是中性值，不会过度影响综合评分
- 记录错误日志，便于排查问题

**实现**:
- 捕获AI评估异常
- 记录错误日志
- 返回默认相似度0.5
- 继续后续流程

### Decision 7: DryRun模式支持
**选择**: DryRun模式下跳过AI调用，使用默认相似度0.5

**理由**:
- 避免在测试时产生API调用费用
- 可以测试除AI评估外的所有功能
- 保持DryRun模式的完整性

**实现**:
- 检测DryRun模式标志
- 跳过AI评估调用
- 使用默认相似度0.5
- 记录DryRun日志

## Risks / Trade-offs

### Risk 1: 1688 API可用性和稳定性
**风险**: 1688 API可能不稳定或限制访问频率
**缓解**:
- 实现重试机制（最多2次）
- 实现超时控制（20秒）
- 提供清晰的错误提示
- 支持DryRun模式测试

### Risk 2: AI API成本和可用性
**风险**: Qwen API调用可能产生费用，服务可能不可用
**缓解**:
- 实现降级策略（失败时使用默认值）
- 支持DryRun模式
- 批量评估减少调用次数
- 提供成本估算文档

### Risk 3: 匹配准确性
**风险**: 图片相似度和AI评估可能不够准确
**缓解**:
- 使用综合评分提高准确性
- 允许用户调整权重参数
- 提供详细的匹配日志，便于调优
- 支持人工审核和反馈

### Risk 4: 性能影响
**风险**: 货源匹配可能增加整体处理时间
**缓解**:
- 图片相似度预过滤减少AI调用
- 支持异步处理（未来优化）
- 提供性能监控，识别瓶颈
- 允许用户选择是否启用货源匹配

### Risk 5: 环境变量管理
**风险**: 用户可能忘记配置环境变量
**缓解**:
- 提供清晰的错误提示
- 在文档中说明必需的环境变量
- 支持配置文件方式（未来扩展）
- 在DryRun模式下提供警告

## Migration Plan

### 阶段 1: 核心功能开发
- 实现1688 API抓取器
- 实现AI评估模块
- 实现货源匹配器

### 阶段 2: 集成和测试
- 扩展数据模型
- 集成到主流程
- 编写测试用例

### 阶段 3: 优化和文档
- 性能优化
- 错误处理完善
- 文档编写

### 阶段 4: 验证和发布
- 端到端测试
- 性能测试
- 用户验收测试

## Open Questions

1. **是否需要支持多货源选择？**
   - 当前决定：返回所有符合条件的货源，由用户选择
   - 如果用户反馈需要自动选择最佳货源，可以在后续版本中添加

2. **是否需要缓存匹配结果？**
   - 当前决定：不缓存，每次重新匹配
   - 如果性能成为问题，可以考虑缓存机制

3. **是否需要支持其他货源平台？**
   - 当前决定：只支持1688
   - 如果用户需要其他平台，可以在后续版本中扩展

4. **AI评估的批量大小？**
   - 当前决定：默认5个商品一批
   - 可以根据实际效果调整

