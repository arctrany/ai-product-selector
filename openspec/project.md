# 项目上下文

## 项目目标
AI选品自动化系统是一个跨境电商选品工具，专注于OZON等俄语电商平台的商品数据抓取、价格分析和利润计算。系统通过自动化流程帮助商家快速识别有利润潜力的商品和优质店铺，提高选品效率和成功率。

## 技术栈
- **核心语言**: Python 3.x
- **异步框架**: asyncio (异步并发处理)
- **浏览器自动化**: Playwright
- **数据处理**: pandas, openpyxl (Excel处理)
- **Web抓取**: BeautifulSoup, requests
- **数据模型**: Pydantic, dataclasses
- **日志系统**: Python logging
- **配置管理**: JSON配置文件
- **测试框架**: unittest, pytest

## 项目约定

### 代码风格
- **命名约定**: 
  - 类名使用 PascalCase (如 `GoodStoreSelector`)
  - 函数和变量使用 snake_case (如 `extract_product_info`)
  - 常量使用 UPPER_SNAKE_CASE (如 `MAX_RETRY_COUNT`)
- **文档字符串**: 使用三重引号，包含功能描述、参数说明和返回值
- **类型注解**: 强制使用类型提示，特别是函数参数和返回值
- **错误处理**: 使用自定义异常类，避免裸露的 try-catch
- **Clean Code 原则**:
  - 避免冗余代码，提取公共逻辑到独立函数或类
  - 函数保持短小，单一职责（建议≤50行）
  - 避免深层嵌套（建议≤3层）
  - 使用有意义的变量名，减少注释需求
  - 优先组合而非继承，保持代码简洁
- **数据模型定义**: 
  - 优先使用 `@dataclass` 装饰器定义数据模型
  - 数据类必须包含类型注解
  - 使用 `Optional` 标记可选字段
  - 实现 `__post_init__` 方法进行数据验证
  - 示例：`@dataclass class ProductInfo: product_id: str; green_price: Optional[float] = None`

### 架构模式
- **模块化设计**: 按功能领域划分模块 (cli, common, rpa, business)
- **单一职责**: 每个类和函数只负责一个明确的功能
- **依赖注入**: 通过配置对象传递依赖，避免硬编码
- **异步处理策略**: 
  - **底层（RPA、网络IO）**: 优先使用异步模式（async/await）提高并发性能
  - **业务层（业务逻辑、数据处理）**: 以同步模式为主，保持代码简洁易读
  - 异步向同步转换使用 `asyncio.run()` 或事件循环封装
- **并发处理**: 
  - 使用 `asyncio.gather()` 实现并发执行多个异步任务
  - 设置 `return_exceptions=True` 确保单个任务失败不影响其他任务
  - 合理控制并发数量，避免资源耗尽
- **状态管理**: 
  - 使用统一的状态管理器（如 `UIStateManager`）集中管理应用状态
  - 支持状态变更的事件订阅和通知机制
  - 状态枚举使用 `Enum` 类型定义（如 `AppState.RUNNING`）
- **错误隔离**: 单个店铺/商品的错误不影响整体流程
- **批量处理**: 
  - 大数据量处理时采用分批策略，控制内存占用
  - 设置合理的批次大小（建议单批≤100条记录）
  - 批次间添加适当延迟，避免资源耗尽
- **跨平台兼容**: 支持 Windows、Linux、macOS 三大操作系统
- **配置驱动**: 所有选择器、关键字、路径通过配置文件管理

### 🏗️ 分层架构原则 (重构后统一架构)

#### **工具层 (Utils Layer)**
**职责**: 提供可复用的工具类和辅助函数
- **WaitUtils** (`common/utils/wait_utils.py`): 统一时序控制
  - 显式等待替代硬编码 `time.sleep()`
  - 元素可见性/可点击性等待
  - URL变化检测、条件等待
- **ScrapingUtils** (`common/utils/scraping_utils.py`): 统一数据提取
  - 价格提取和验证
  - 文本清理和规范化
  - URL处理和ID提取
  - 结构化数据提取

**设计原则**:
- 无状态设计，纯函数式工具方法
- 高度可复用，所有Scraper共享
- 消除重复逻辑，统一实现标准

#### **抓取层 (Scraping Layer)**
**职责**: 页面交互和原始数据获取
- **BaseScraper**: 所有Scraper的基类，提供通用功能
- **SeerfarScraper**: Seerfar平台店铺和商品数据抓取
- **OzonScraper**: OZON平台商品价格信息抓取
- **CompetitorScraper**: 跟卖店铺数据抓取
- **ErpPluginScraper**: ERP插件区域数据抓取

**设计原则**:
- 单一职责：每个Scraper专注特定平台或功能
- 职责分离：只负责数据抓取，不做业务逻辑计算
- 统一工具：必须使用WaitUtils和ScrapingUtils
- 标准接口：统一的方法签名和返回格式（ScrapingResult）

#### **服务层 (Service Layer)**
**职责**: 独立的业务服务和跨Scraper功能
- **CompetitorDetectionService** (`common/services/`): 独立的跟卖检测服务
  - 跟卖区域检测
  - 跟卖数据提取
  - 价格比较分析

**设计原则**:
- 服务独立性：可被多个Scraper调用
- 业务封装：封装复杂的业务逻辑
- 统一接口：返回标准数据模型

#### **业务层 (Business Layer)**
**职责**: 业务规则计算和数据处理
- **FilterManager** (`business/filter_manager.py`): 店铺和商品过滤
- **PricingCalculator** (`common/business/pricing_calculator.py`): 价格计算
- **ProfitEvaluator** (`common/business/profit_evaluator.py`): 利润评估
- **StoreEvaluator** (`common/business/store_evaluator.py`): 店铺评估

**设计原则**:
- 业务逻辑集中管理
- 与数据抓取层解耦
- 可独立测试和复用

#### **配置层 (Config Layer)**
**职责**: 统一配置管理
- **BaseScrapingConfig**: 所有Scraper配置的基类
- **OzonSelectorsConfig**: OZON选择器配置
- **SeerfarSelectors**: Seerfar选择器配置
- **ERPSelectorsConfig**: ERP选择器配置

**设计原则**:
- 配置继承：所有配置继承BaseScrapingConfig
- 统一接口：`get_selector()`, `get_selectors()`, `validate()`
- 集中管理：避免配置分散和重复

#### **数据模型层 (Data Model Layer)**
**职责**: 标准数据传输对象
- **ScrapingResult**: 统一抓取结果格式
- **CompetitorInfo**: 跟卖店铺信息
- **CompetitorDetectionResult**: 跟卖检测结果
- **ProductScrapingResult**: 商品抓取结果

**设计原则**:
- 类型安全：使用dataclass和类型注解
- 标准化：所有Scraper使用统一数据格式
- 可扩展：支持metadata字段扩展


### 跨平台兼容性规范
- **路径处理**: 使用 `pathlib.Path` 处理文件路径，避免硬编码路径分隔符
- **环境变量**: 通过 `os.environ` 获取系统环境变量，支持不同操作系统
- **字符编码**: 统一使用 UTF-8 编码处理文件和网络数据
- **浏览器支持**: 
  - Windows: Chrome, Edge, Firefox
  - macOS: Chrome, Safari, Edge, Firefox  
  - Linux: Chrome, Firefox (通过包管理器安装)
- **依赖管理**: 使用 `requirements.txt` 管理跨平台Python依赖
- **系统调用**: 避免平台特定的系统调用，使用Python标准库替代

### Playwright 性能优化规范
- **浏览器复用**: 
  - 单个任务内复用浏览器实例和上下文
  - 避免频繁创建/销毁浏览器进程
  - 使用连接池管理多个浏览器实例
- **页面管理**:
  - 及时关闭不需要的页面和标签页
  - 限制同时打开的页面数量 (建议≤5个)
  - 使用页面池复用页面对象
- **网络优化**:
  - 禁用不必要的资源加载 (图片、CSS、字体等)
  - 设置合理的超时时间 (页面加载30s，元素等待10s)
  - 使用请求拦截优化网络请求
- **内存管理**:
  - 定期清理页面缓存和Cookie
  - 监控内存使用，避免内存泄漏
  - 大批量处理时分批执行，避免OOM

### 选择器和配置最佳实践
- **选择器策略**:
  - 优先使用稳定的属性选择器 (`data-*`, `id`, `class`)
  - 避免依赖页面结构的复杂CSS选择器
  - 使用多重选择器策略，提供备选方案
  - 支持XPath和CSS选择器的动态切换
- **配置文件管理**:
  - 所有选择器、URL、关键字存储在JSON配置文件中
  - 支持环境特定的配置覆盖 (dev/prod/test)
  - 提供配置验证和默认值机制
  - 支持热重载配置，无需重启应用
- **国际化支持**:
  - 支持多语言关键字配置 (中文、俄语、英语)
  - 文本匹配使用正则表达式，支持模糊匹配
  - 货币、日期格式的本地化处理

### 测试策略
- **单元测试**: 
  - 核心业务逻辑必须有单元测试覆盖
  - 测试文件命名：`test_*.py`，测试类命名：`Test*`，测试方法命名：`test_*`
  - 每个公共方法至少一个测试用例
- **集成测试**: 
  - 抓取器和业务组件的集成测试
  - 测试真实的浏览器交互和数据流
  - 使用独立的测试配置和测试数据目录
- **模拟测试**: 
  - 使用 `unittest.mock` 或 `pytest-mock` 避免对外部服务的依赖
  - 模拟网络请求、文件IO、浏览器操作等外部依赖
- **性能测试**: 
  - 关键路径的性能基准测试
  - 设置性能阈值，超时自动失败
- **测试数据**: 
  - 使用真实但脱敏的测试用例
  - 测试数据存放在 `tests/test_data/` 目录
- **测试覆盖率目标**:
  - 核心业务模块覆盖率 ≥ 80%
  - 关键路径（利润计算、价格计算）覆盖率 = 100%
  - 定期运行覆盖率检查：`pytest --cov=common --cov=rpa`

### Git 工作流
- **分支策略**: 功能分支开发，主分支保持稳定
- **提交约定**: 使用语义化提交信息 (feat:, fix:, refactor:, test:)
- **代码审查**: 重要功能变更需要代码审查
- **版本管理**: 使用语义化版本号

### 文件管理规范
- **严禁创建备份文件**: 
  - ❌ 禁止创建任何形式的备份文件（如 `*_backup.py`, `*.bak`, `*_old.py`, `enhanced_*.py` 等）
  - ❌ 禁止通过复制文件的方式保存历史版本
  - ✅ 使用 Git 版本控制管理所有代码变更历史
  - ✅ 重大重构前创建 feature 分支或提交 commit
  - ✅ 如需临时保存代码，使用 Git stash 或创建临时分支
- **原因**: 
  - 备份文件会污染代码库，增加维护成本
  - Git 版本控制系统已提供完整的历史管理功能
  - 备份文件容易与正式文件混淆，导致误用过期代码
  - 影响代码搜索和导航效率
- **清理策略**: 
  - 定期检查并删除意外创建的备份文件
  - 在 `.gitignore` 中添加备份文件模式以防止误提交

## 领域上下文
- **OZON平台**: 俄罗斯主要电商平台，类似于Amazon
- **Seerfar**: 第三方数据分析平台，提供店铺销售数据
- **ERP插件**: 浏览器插件，提供商品的采购价格和物流信息
- **跟卖**: 多个卖家销售相同商品的竞争模式
- **利润计算**: 考虑采购价、佣金、物流、汇率等因素的复合计算
- **好店标准**: 基于有利润商品比例判定的店铺质量评估

### 价格术语定义
- **绿标价格（Green Price）**: 商品的促销价格，通常是打折后的价格，显示为绿色标签，是吸引消费者的优惠价
- **黑标价格（Black Price）**: 商品的原价或标准售价，显示为黑色标签，是未打折的正常价格
- **跟卖价格（Competitor Price）**: 同一商品的竞争对手（跟卖卖家）的售价，用于价格竞争力分析

## 重要约束
- **平台限制**: 必须遵守OZON等平台的爬虫政策和频率限制
- **浏览器依赖**: 需要Chrome/Chromium、Edge浏览器支持
- **网络稳定性**: 依赖稳定的网络连接进行数据抓取
- **数据准确性**: 价格和库存信息具有时效性
- **跨平台兼容**: 支持Windows、macOS、Linux系统
- **内存使用**: 大批量处理时需要控制内存占用

## 技术实现规范

### 错误处理和重试机制
- **分层异常处理**: 
  - 网络异常: `NetworkError`, `TimeoutError`
  - 页面异常: `PageLoadError`, `ElementNotFoundError`
  - 业务异常: `DataExtractionError`, `ValidationError`
- **智能重试策略**:
  - 网络请求: 指数退避重试，最多3次
  - 页面加载: 线性重试，最多2次
  - 元素查找: 短间隔重试，最多5次
- **优雅降级**: 单个商品/店铺失败不影响整体流程

### 日志和监控规范
- **结构化日志**: 
  - 推荐使用结构化日志格式（支持 JSON 或标准格式）
  - 必须包含时间戳、日志级别、模块名称、消息内容
  - 使用 Python logging 模块，配置统一的日志格式
  - 敏感信息（密码、Token）必须脱敏处理
- **性能监控**: 
  - 记录关键操作的执行时间和资源消耗
  - 对耗时操作（>1秒）输出性能日志
  - 监控内存使用，及时发现内存泄漏
- **错误追踪**: 
  - 详细记录异常堆栈和上下文信息
  - 包含失败时的输入参数和中间状态
  - 使用不同日志级别区分错误严重程度
- **进度报告**: 
  - 实时更新任务进度和状态信息
  - 长时间任务定期输出进度日志（如每处理10%）
  - 提供可视化的进度反馈（CLI 进度条、状态更新）

### 数据验证和清洗
- **输入验证**: 使用Pydantic模型验证所有输入数据
- **数据清洗**: 
  - 价格数据: 去除货币符号，统一数值格式
  - 文本数据: 去除HTML标签，标准化空白字符
  - URL数据: 验证格式，处理相对路径
- **数据完整性**: 确保必要字段不为空，数据类型正确

### 安全和隐私保护
- **用户代理轮换**: 使用多个真实浏览器User-Agent
- **请求频率控制**: 避免过于频繁的请求触发反爬机制
- **数据脱敏**: 敏感信息在日志中进行脱敏处理
- **本地存储**: 避免在代码中硬编码敏感配置信息

## 模块架构

### 📁 CLI模块 (`cli/`)
**职责**: 命令行界面和用户交互层
- **`main.py`**: CLI应用主入口，命令解析和分发
- **`models.py`**: UI数据模型和状态管理
  - `AppState`: 应用状态枚举 (IDLE, RUNNING, PAUSED, COMPLETED, ERROR)
  - `UIConfig`: 用户配置参数 (文件路径、筛选条件、输出设置)
  - `ProgressInfo`: 进度跟踪信息
  - `UIStateManager`: 全局状态管理器，支持事件订阅
- **`task_controller.py`**: 任务控制器，管理任务生命周期
- **`preset_manager.py`**: 配置预设管理
- **`log_manager.py`**: 日志管理和导出功能

### 📁 Common模块 (`common/`)
**职责**: 核心业务逻辑和数据处理

#### 🔧 业务逻辑子模块 (`common/business/`)
**职责**: 具体的业务逻辑，包括规则计算、价格计算等，提供各种函数可以通过xp_flow注入到各个数据抓取流程中

- **`pricing_calculator.py`**: 价格计算
  - 计算真实的绿标、黑标价格
  - 佣金计算和定价逻辑
  - 汇率转换 (卢布→人民币)
  - 商品定价计算 (95折策略)
  - 完整定价流程和利润分析
- **`profit_evaluator.py`**: 利润评估
  - 通过输入综合的商品信息并利用**利润计算器**，真实的计算利润
  - 考虑采购价、佣金、物流、汇率等因素的复合计算
- **`store_evaluator.py`**: 店铺评估
  - 通过店铺信息以及商品信息，计算店铺的综合评分，用于店铺筛选
  - 基于有利润商品比例判定的店铺质量评估
- **`source_matcher.py`**: 货源匹配器

**架构特点**:
- **规则计算**: 提供各种业务规则的计算函数
- **流程注入**: 通过xp_flow注入到各个数据抓取流程中
- **模块化设计**: 每个业务功能独立封装，便于复用和维护

#### 🕷️ 数据抓取子模块 (`common/scrapers/`)
**职责**: 具体页面的交互过程及抓取，严格按单一职责原则分工

- **`seerfar_scraper.py`**: 只负责seerfar店铺信息的交互和获取，以及seerfar店铺列表商品信息的获取
- **`ozon_scraper.py`**: 只负责商详的信息交互和抓取，不负责逻辑，最后按要求返回商品的详情信息
- **`competitor_scraper.py`**: 只负责跟卖店铺的抓取和交互
- **`erp_plugin_scraper.py`**: 只负责erp插件区域的信息抓取
- **`api_scraper.py`**: 利用api接口获取数据（待建）
- **`xuanping_browser_service.py`**: 选评专用浏览器服务

**设计原则**:
- **单一职责**: 每个scraper只负责特定平台或特定功能的数据抓取
- **职责分离**: 抓取器不负责业务逻辑计算，只负责数据获取和返回
- **标准化接口**: 所有抓取器遵循统一的接口规范

#### 📊 数据模型和配置
- **`models.py`**: 核心数据模型定义
  - `StoreInfo`: 店铺基础信息和状态
  - `ProductInfo`: 商品信息和价格数据
  - `PriceCalculationResult`: 价格计算结果
  - `CompetitorStore`: 跟卖店铺信息
  - `BatchProcessingResult`: 批量处理结果
- **`config.py`**: 系统配置管理
- **`excel_processor.py`**: Excel文件处理
- **`task_control.py`**: 任务控制和状态管理

### 🤖 RPA模块 (`rpa/`)
**职责**: 浏览器自动化和页面操作

#### 核心服务层
- **`browser_service.py`**: 精简版浏览器服务
  - 浏览器生命周期管理
  - 共享实例管理 (支持浏览器复用)
  - 页面导航和组件协调
  - 统一的配置管理和错误处理

#### 接口定义层 (`core/interfaces/`)
- **`browser_driver.py`**: 浏览器驱动抽象接口
- **`page_analyzer.py`**: 页面分析器接口
- **`paginator.py`**: 分页器接口

#### 实现层 (`implementations/`)
- **`playwright_browser_driver.py`**: Playwright浏览器驱动实现
- **`dom_page_analyzer.py`**: DOM页面分析器
- **`universal_paginator.py`**: 通用分页器

#### 配置和模型
- **`core/config/`**: 浏览器服务配置管理
- **`core/models/`**: 页面元素和浏览器状态模型
- **`core/exceptions/`**: 浏览器相关异常定义

#### 架构和编码规范
- **参考文档**: [`rpa/docs/browser_architecture_and_coding_standards.md`](../rpa/docs/browser_architecture_and_coding_standards.md)
  - 定义了浏览器服务模块的架构设计规范
  - 制定了统一的编码标准和最佳实践
  - 包含完整的设计模式、错误处理、跨平台兼容性指南
  - 提供了技术债务清理计划和快速参考指南

### 🧪 Tests模块 (`tests/`)
**职责**: 测试套件和质量保证
- **单元测试**: 各组件的独立功能测试
- **集成测试**: 跨模块协作测试
- **性能测试**: 关键路径性能验证
- **真实场景测试**: 基于实际数据的端到端测试

## 模块依赖关系

```
┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│   CLI模块   │───▶│  Common模块  │───▶│   RPA模块   │
│             │    │              │    │             │
│ • 用户界面  │    │ • 业务逻辑   │    │ • 浏览器    │
│ • 状态管理  │    │ • 数据抓取   │    │ • 页面操作  │
│ • 任务控制  │    │ • 数据处理   │    │ • 元素分析  │
└─────────────┘    └──────────────┘    └─────────────┘
       │                   │                   │
       └───────────────────┼───────────────────┘
                           ▼
                  ┌──────────────┐
                  │  外部服务    │
                  │              │
                  │ • OZON平台   │
                  │ • Seerfar    │
                  │ • ERP插件    │
                  └──────────────┘
```

### 数据流向
1. **CLI层**: 接收用户输入，管理任务状态
2. **Common层**: 执行核心业务逻辑，协调各个抓取器
3. **RPA层**: 提供浏览器自动化能力，支持页面操作
4. **外部服务**: 提供数据源和业务支持

### 关键设计原则
- **分层架构**: 清晰的职责分离，上层依赖下层
- **接口抽象**: 通过接口定义实现依赖倒置
- **配置驱动**: 通过配置对象管理系统行为
- **异步优先**: 网络IO和文件操作使用异步模式
- **错误隔离**: 单点故障不影响整体系统稳定性

## 外部依赖
- **OZON网站**: 商品价格和跟卖信息的数据源
- **Seerfar API**: 店铺销售数据和分析报告
- **ERP插件服务**: 商品采购价格和供应链信息
- **1688平台**: 货源匹配和价格对比
- **汇率API**: 实时汇率转换服务
- **浏览器驱动**: ChromeDriver或其他WebDriver实现
