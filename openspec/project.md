# 项目上下文

## 项目目标
AI选品自动化系统是一个跨境电商选品工具，专注于OZON等俄语电商平台的商品数据抓取、价格分析和利润计算。系统通过自动化流程帮助商家快速识别有利润潜力的商品和优质店铺，提高选品效率和成功率。

## 技术栈
- **核心语言**: Python 3.x
- **异步框架**: asyncio (异步并发处理)
- **浏览器自动化**: Playwright
- **数据处理**: pandas, openpyxl (Excel处理)
- **Web抓取**: BeautifulSoup, requests
- **数据模型**: Pydantic, dataclasses
- **日志系统**: Python logging
- **配置管理**: JSON配置文件
- **测试框架**: unittest, pytest

## 项目约定

### 代码风格
- **命名约定**: 
  - 类名使用 PascalCase (如 `GoodStoreSelector`)
  - 函数和变量使用 snake_case (如 `extract_product_info`)
  - 常量使用 UPPER_SNAKE_CASE (如 `MAX_RETRY_COUNT`)
- **文档字符串**: 使用三重引号，包含功能描述、参数说明和返回值
- **类型注解**: 强制使用类型提示，特别是函数参数和返回值
- **错误处理**: 使用自定义异常类，避免裸露的 try-catch
- **Clean Code 原则**:
  - 避免冗余代码，提取公共逻辑到独立函数或类
  - 函数保持短小，单一职责（建议≤50行）
  - 避免深层嵌套（建议≤3层）
  - 使用有意义的变量名，减少注释需求
  - 优先组合而非继承，保持代码简洁
- **数据模型定义**: 
  - 优先使用 `@dataclass` 装饰器定义数据模型
  - 数据类必须包含类型注解
  - 使用 `Optional` 标记可选字段
  - 实现 `__post_init__` 方法进行数据验证
  - 示例：`@dataclass class ProductInfo: product_id: str; green_price: Optional[float] = None`

### 架构模式
- **模块化设计**: 按功能领域划分模块 (cli, common, rpa, business)
- **单一职责**: 每个类和函数只负责一个明确的功能
- **依赖注入**: 通过配置对象传递依赖，避免硬编码
- **异步处理策略**: 
  - **底层（RPA、网络IO）**: 优先使用异步模式（async/await）提高并发性能
  - **业务层（业务逻辑、数据处理）**: 以同步模式为主，保持代码简洁易读
  - 异步向同步转换使用 `asyncio.run()` 或事件循环封装
- **并发处理**: 
  - 使用 `asyncio.gather()` 实现并发执行多个异步任务
  - 设置 `return_exceptions=True` 确保单个任务失败不影响其他任务
  - 合理控制并发数量，避免资源耗尽
- **状态管理**: 
  - 使用统一的状态管理器（如 `UIStateManager`）集中管理应用状态
  - 支持状态变更的事件订阅和通知机制
  - 状态枚举使用 `Enum` 类型定义（如 `AppState.RUNNING`）
- **错误隔离**: 单个店铺/商品的错误不影响整体流程
- **批量处理**: 
  - 大数据量处理时采用分批策略，控制内存占用
  - 设置合理的批次大小（建议单批≤100条记录）
  - 批次间添加适当延迟，避免资源耗尽
- **跨平台兼容**: 支持 Windows、Linux、macOS 三大操作系统
- **配置驱动**: 所有选择器、关键字、路径通过配置文件管理

### 🏗️ 分层架构原则 (重构后统一模块化架构)

#### 🎯 **数据模型层 (Data Model Layer)** - **新架构**
**位置**: `common/models/`  
**职责**: 标准化数据传输对象和业务实体定义

**核心组件**:
- **业务模型** (`business_models.py`): 店铺、商品、价格计算等核心业务实体
- **抓取模型** (`scraping_models.py`): 统一抓取结果和跟卖检测结果
- **Excel模型** (`excel_models.py`): Excel处理和验证结果
- **系统枚举** (`enums.py`): 抓取状态、筛选类型、店铺类型
- **异常定义** (`exceptions.py`): 抓取异常、验证异常

**设计原则**:
- **类型安全**: 使用dataclass和完整类型注解
- **标准化**: 所有模块使用统一数据格式
- **可扩展**: 支持metadata字段和继承扩展
- **向后兼容**: `__init__.py`保持原有导入接口

#### ⚙️ **配置管理层 (Config Layer)** - **新架构**
**位置**: `common/config/`  
**职责**: 分层的配置管理体系

**核心组件**:
- **基础配置** (`base_config.py`): 系统主配置和抓取配置基类
- **系统配置** (`system_config.py`): 日志、性能等技术配置
- **业务配置** (`business_config.py`): 筛选、价格等业务配置
- **平台配置**: OZON、Seerfar、ERP等平台特定选择器配置

**设计原则**:
- **配置继承**: 所有配置继承BaseScrapingConfig
- **职责分离**: 技术配置与业务配置分离
- **统一接口**: `get_selector()`, `get_selectors()`, `validate()`
- **集中管理**: 避免配置分散，支持环境特定覆盖

#### 🛠️ **工具函数层 (Utils Layer)** - **增强**
**位置**: `common/utils/`  
**职责**: 可复用的工具类和辅助函数

**核心组件**:
- **模型工具** (`model_utils.py` - **新增**): 数据验证、格式化、利润计算
- **抓取工具** (`scraping_utils.py` - **增强**): 价格提取、文本清理、ID提取
- **时序工具** (`wait_utils.py`): 显式等待、条件等待、URL变化检测

**设计原则**:
- **无状态设计**: 纯函数式工具方法
- **高度复用**: 所有Scraper和业务模块共享
- **消除重复**: 统一实现标准，避免重复逻辑

#### 🔧 **业务逻辑层 (Business Layer)**
**位置**: `common/business/`  
**职责**: 业务规则计算和数据处理

**核心组件**:
- **价格计算器** (`pricing_calculator.py`): 绿标黑标价格、佣金、汇率转换
- **利润评估器** (`profit_evaluator.py`): 综合利润计算和分析
- **店铺评估器** (`store_evaluator.py`): 店铺质量评分和筛选
- **货源匹配器** (`source_matcher.py`): 货源匹配和价格对比

**设计原则**:
- **业务逻辑集中**: 核心计算逻辑统一管理
- **与抓取解耦**: 独立于数据来源，可独立测试
- **流程注入**: 通过xp_flow注入到抓取流程

#### 🕷️ **数据抓取层 (Scraping Layer)**
**位置**: `common/scrapers/`  
**职责**: 平台特定的页面交互和原始数据获取

**核心组件**:
- **Seerfar抓取器**: 店铺和商品信息抓取
- **OZON抓取器**: 商详信息和价格数据抓取  
- **竞争对手抓取器**: 跟卖店铺数据抓取
- **ERP插件抓取器**: 采购价格和供应链信息
- **选评浏览器服务**: 专用浏览器服务实现

**设计原则**:
- **单一职责**: 每个Scraper专注特定平台或功能
- **职责分离**: 只负责数据抓取，不做业务计算
- **统一工具**: 必须使用Utils层工具函数
- **标准接口**: 统一方法签名和返回格式

#### 🤖 **基础设施层 (Infrastructure Layer)**
**位置**: `rpa/`  
**职责**: 浏览器自动化和页面操作能力

**核心组件**:
- **浏览器服务**: 生命周期管理、共享实例、配置管理
- **抽象接口**: 驱动、分析器、分页器接口定义
- **具体实现**: Playwright驱动、DOM分析、通用分页

**设计原则**:
- **接口抽象**: 通过接口实现依赖倒置
- **实现解耦**: 支持多种浏览器引擎
- **资源管理**: 浏览器实例复用和内存优化


### 跨平台兼容性规范
- **路径处理**: 使用 `pathlib.Path` 处理文件路径，避免硬编码路径分隔符
- **环境变量**: 通过 `os.environ` 获取系统环境变量，支持不同操作系统
- **字符编码**: 统一使用 UTF-8 编码处理文件和网络数据
- **浏览器支持**: 
  - Windows: Chrome, Edge, Firefox
  - macOS: Chrome, Safari, Edge, Firefox  
  - Linux: Chrome, Firefox (通过包管理器安装)
- **依赖管理**: 使用 `requirements.txt` 管理跨平台Python依赖
- **系统调用**: 避免平台特定的系统调用，使用Python标准库替代

### Playwright 性能优化规范
- **浏览器复用**: 
  - 单个任务内复用浏览器实例和上下文
  - 避免频繁创建/销毁浏览器进程
  - 使用连接池管理多个浏览器实例
- **页面管理**:
  - 及时关闭不需要的页面和标签页
  - 限制同时打开的页面数量 (建议≤5个)
  - 使用页面池复用页面对象
- **网络优化**:
  - 禁用不必要的资源加载 (图片、CSS、字体等)
  - 设置合理的超时时间 (页面加载30s，元素等待10s)
  - 使用请求拦截优化网络请求
- **内存管理**:
  - 定期清理页面缓存和Cookie
  - 监控内存使用，避免内存泄漏
  - 大批量处理时分批执行，避免OOM

### 选择器和配置最佳实践
- **选择器策略**:
  - 优先使用稳定的属性选择器 (`data-*`, `id`, `class`)
  - 避免依赖页面结构的复杂CSS选择器
  - 使用多重选择器策略，提供备选方案
  - 支持XPath和CSS选择器的动态切换
- **配置文件管理**:
  - 所有选择器、URL、关键字存储在JSON配置文件中
  - 支持环境特定的配置覆盖 (dev/prod/test)
  - 提供配置验证和默认值机制
  - 支持热重载配置，无需重启应用
- **国际化支持**:
  - 支持多语言关键字配置 (中文、俄语、英语)
  - 文本匹配使用正则表达式，支持模糊匹配
  - 货币、日期格式的本地化处理

### 测试策略
- **单元测试**: 
  - 核心业务逻辑必须有单元测试覆盖
  - 测试文件命名：`test_*.py`，测试类命名：`Test*`，测试方法命名：`test_*`
  - 每个公共方法至少一个测试用例
- **集成测试**: 
  - 抓取器和业务组件的集成测试
  - 测试真实的浏览器交互和数据流
  - 使用独立的测试配置和测试数据目录
- **模拟测试**: 
  - 使用 `unittest.mock` 或 `pytest-mock` 避免对外部服务的依赖
  - 模拟网络请求、文件IO、浏览器操作等外部依赖
- **性能测试**: 
  - 关键路径的性能基准测试
  - 设置性能阈值，超时自动失败
- **测试数据**: 
  - 使用真实但脱敏的测试用例
  - 测试数据存放在 `tests/test_data/` 目录
- **测试覆盖率目标**:
  - 核心业务模块覆盖率 ≥ 80%
  - 关键路径（利润计算、价格计算）覆盖率 = 100%
  - 定期运行覆盖率检查：`pytest --cov=common --cov=rpa`

### Git 工作流
- **分支策略**: 功能分支开发，主分支保持稳定
- **提交约定**: 使用语义化提交信息 (feat:, fix:, refactor:, test:)
- **代码审查**: 重要功能变更需要代码审查
- **版本管理**: 使用语义化版本号

### 文件管理规范
- **严禁创建备份文件**: 
  - ❌ 禁止创建任何形式的备份文件（如 `*_backup.py`, `*.bak`, `*_old.py`, `enhanced_*.py` 等）
  - ❌ 禁止通过复制文件的方式保存历史版本
  - ✅ 使用 Git 版本控制管理所有代码变更历史
  - ✅ 重大重构前创建 feature 分支或提交 commit
  - ✅ 如需临时保存代码，使用 Git stash 或创建临时分支
- **原因**: 
  - 备份文件会污染代码库，增加维护成本
  - Git 版本控制系统已提供完整的历史管理功能
  - 备份文件容易与正式文件混淆，导致误用过期代码
  - 影响代码搜索和导航效率
- **清理策略**: 
  - 定期检查并删除意外创建的备份文件
  - 在 `.gitignore` 中添加备份文件模式以防止误提交

## 领域上下文
- **OZON平台**: 俄罗斯主要电商平台，类似于Amazon
- **Seerfar**: 第三方数据分析平台，提供店铺销售数据
- **ERP插件**: 浏览器插件，提供商品的采购价格和物流信息
- **跟卖**: 多个卖家销售相同商品的竞争模式
- **利润计算**: 考虑采购价、佣金、物流、汇率等因素的复合计算
- **好店标准**: 基于有利润商品比例判定的店铺质量评估

### 价格术语定义
- **绿标价格（Green Price）**: 商品的促销价格，通常是打折后的价格，显示为绿色标签，是吸引消费者的优惠价
- **黑标价格（Black Price）**: 商品的原价或标准售价，显示为黑色标签，是未打折的正常价格
- **跟卖价格（Competitor Price）**: 同一商品的竞争对手（跟卖卖家）的售价，用于价格竞争力分析

## 重要约束
- **平台限制**: 必须遵守OZON等平台的爬虫政策和频率限制
- **浏览器依赖**: 需要Chrome/Chromium、Edge浏览器支持
- **网络稳定性**: 依赖稳定的网络连接进行数据抓取
- **数据准确性**: 价格和库存信息具有时效性
- **跨平台兼容**: 支持Windows、macOS、Linux系统
- **内存使用**: 大批量处理时需要控制内存占用

## 技术实现规范

### 错误处理和重试机制
- **分层异常处理**: 
  - 网络异常: `NetworkError`, `TimeoutError`
  - 页面异常: `PageLoadError`, `ElementNotFoundError`
  - 业务异常: `DataExtractionError`, `ValidationError`
- **智能重试策略**:
  - 网络请求: 指数退避重试，最多3次
  - 页面加载: 线性重试，最多2次
  - 元素查找: 短间隔重试，最多5次
- **优雅降级**: 单个商品/店铺失败不影响整体流程

### 日志和监控规范
- **结构化日志**: 
  - 推荐使用结构化日志格式（支持 JSON 或标准格式）
  - 必须包含时间戳、日志级别、模块名称、消息内容
  - 使用 Python logging 模块，配置统一的日志格式
  - 敏感信息（密码、Token）必须脱敏处理
- **性能监控**: 
  - 记录关键操作的执行时间和资源消耗
  - 对耗时操作（>1秒）输出性能日志
  - 监控内存使用，及时发现内存泄漏
- **错误追踪**: 
  - 详细记录异常堆栈和上下文信息
  - 包含失败时的输入参数和中间状态
  - 使用不同日志级别区分错误严重程度
- **进度报告**: 
  - 实时更新任务进度和状态信息
  - 长时间任务定期输出进度日志（如每处理10%）
  - 提供可视化的进度反馈（CLI 进度条、状态更新）

### 数据验证和清洗
- **输入验证**: 使用Pydantic模型验证所有输入数据
- **数据清洗**: 
  - 价格数据: 去除货币符号，统一数值格式
  - 文本数据: 去除HTML标签，标准化空白字符
  - URL数据: 验证格式，处理相对路径
- **数据完整性**: 确保必要字段不为空，数据类型正确

### 安全和隐私保护
- **用户代理轮换**: 使用多个真实浏览器User-Agent
- **请求频率控制**: 避免过于频繁的请求触发反爬机制
- **数据脱敏**: 敏感信息在日志中进行脱敏处理
- **本地存储**: 避免在代码中硬编码敏感配置信息

## 模块架构

### 📁 CLI模块 (`cli/`) - **分层架构优化**
**职责**: 命令行界面和用户交互层

#### 🎛️ **CLI配置层** (`cli/config/`) - **新增**
**职责**: CLI层专属配置管理
- **`user_config.py`**: CLI用户配置
  - `CLIConfig`: CLI特定配置
  - 用户交互设置和偏好管理

#### 📱 **CLI核心组件**
- **`main.py`**: CLI应用主入口，命令解析和分发
- **`models.py`**: UI数据模型和状态管理
  - `AppState`: 应用状态枚举 (IDLE, RUNNING, PAUSED, COMPLETED, ERROR)
  - `UIConfig`: 用户配置参数 (文件路径、筛选条件、输出设置)
  - `ProgressInfo`: 进度跟踪信息
  - `UIStateManager`: 全局状态管理器，支持事件订阅
- **`task_controller.py`**: 任务控制器，管理任务生命周期
- **`task_control.py`**: **迁移**任务执行控制接口 *(从common迁移)*
- **`preset_manager.py`**: 配置预设管理
- **`log_manager.py`**: 日志管理和导出功能

#### 🔄 **架构分层优化**
- **清晰职责分离**: CLI层只负责用户交互，不处理业务逻辑
- **配置独立管理**: CLI配置与业务配置分离
- **依赖关系优化**: CLI → Common → RPA 的清晰分层

### 📁 Common模块 (`common/`) - **重构后统一模块化架构**
**职责**: 核心业务逻辑和数据处理，采用完全模块化设计

#### 🎯 **数据模型层** (`common/models/`) - **新架构**
**职责**: 统一的数据传输对象和业务实体定义
- **`enums.py`**: 系统枚举定义
  - `ScrapingStatus`: 抓取状态 (SUCCESS, FAILED, PARTIAL, TIMEOUT, ERROR)
  - `FilterType`: 筛选类型
  - `StoreType`: 店铺类型
- **`business_models.py`**: 业务领域模型
  - `StoreInfo`: 店铺基础信息和状态
  - `CompetitorStore`: 跟卖店铺信息
  - `ProductInfo`: 商品信息和价格数据
  - `PriceCalculationResult`: 价格计算结果
- **`scraping_models.py`**: 抓取相关模型
  - `ScrapingResult`: 统一抓取结果格式
  - `CompetitorDetectionResult`: 跟卖检测结果
  - `ProductScrapingResult`: 商品抓取结果扩展
- **`excel_models.py`**: Excel处理模型
  - `ExcelProcessingResult`: Excel处理结果
  - `ExcelValidationError`: Excel验证错误
- **`exceptions.py`**: 自定义异常类
  - `ScrapingException`: 抓取异常基类
  - `ValidationException`: 数据验证异常
- **`__init__.py`**: **向后兼容性导出**
  - 保持原有导入路径的兼容性
  - 统一模型导出接口

#### ⚙️ **配置管理层** (`common/config/`) - **新架构**
**职责**: 分层的配置管理体系
- **`base_config.py`**: 配置基类和主配置
  - `GoodStoreSelectorConfig`: 主系统配置
  - `BaseScrapingConfig`: 抓取配置基类
- **`system_config.py`**: 系统技术配置
  - `LoggingConfig`: 日志系统配置
  - `PerformanceConfig`: 性能配置
- **`business_config.py`**: 业务配置
  - `FilterConfig`: 筛选条件配置
  - `PriceConfig`: 价格计算配置
- **平台选择器配置**:
  - `ozon_selectors_config.py`: OZON选择器配置
  - `seerfar_selectors.py`: Seerfar选择器配置
  - `erp_selectors_config.py`: ERP选择器配置
- **`__init__.py`**: **向后兼容性导出**
  - 保持原有配置导入的兼容性
  - 统一配置接口

#### 🛠️ **工具函数层** (`common/utils/`) - **新架构**
**职责**: 可复用的工具类和辅助函数
- **`model_utils.py`**: **新增**模型相关工具
  - `validate_store_id()`: 店铺ID验证
  - `validate_price()`: 价格数据验证  
  - `format_currency()`: 货币格式化
  - `calculate_profit_rate()`: 利润率计算
- **`scraping_utils.py`**: **增强**抓取工具函数
  - `clean_price_string()`: **迁移**价格字符串清理
  - 统一数据提取和验证功能
  - URL处理和ID提取
- **`wait_utils.py`**: 时序控制工具
- **其他现有工具保持不变**

#### 🔧 业务逻辑子模块 (`common/business/`)
**职责**: 具体的业务逻辑，包括规则计算、价格计算等，提供各种函数可以通过xp_flow注入到各个数据抓取流程中

- **`pricing_calculator.py`**: 价格计算
  - 计算真实的绿标、黑标价格
  - 佣金计算和定价逻辑
  - 汇率转换 (卢布→人民币)
  - 商品定价计算 (95折策略)
  - 完整定价流程和利润分析
- **`profit_evaluator.py`**: 利润评估
  - 通过输入综合的商品信息并利用**利润计算器**，真实的计算利润
  - 考虑采购价、佣金、物流、汇率等因素的复合计算
- **`store_evaluator.py`**: 店铺评估
  - 通过店铺信息以及商品信息，计算店铺的综合评分，用于店铺筛选
  - 基于有利润商品比例判定的店铺质量评估
- **`source_matcher.py`**: 货源匹配器

**架构特点**:
- **规则计算**: 提供各种业务规则的计算函数
- **流程注入**: 通过xp_flow注入到各个数据抓取流程中
- **模块化设计**: 每个业务功能独立封装，便于复用和维护

#### 🕷️ 数据抓取子模块 (`common/scrapers/`)
**职责**: 具体页面的交互过程及抓取，严格按单一职责原则分工

- **`seerfar_scraper.py`**: 只负责seerfar店铺信息的交互和获取，以及seerfar店铺列表商品信息的获取
- **`ozon_scraper.py`**: 只负责商详的信息交互和抓取，不负责逻辑，最后按要求返回商品的详情信息
- **`competitor_scraper.py`**: 只负责跟卖店铺的抓取和交互
- **`erp_plugin_scraper.py`**: 只负责erp插件区域的信息抓取
- **`api_scraper.py`**: 利用api接口获取数据（待建）
- **`xuanping_browser_service.py`**: 选评专用浏览器服务

**设计原则**:
- **单一职责**: 每个scraper只负责特定平台或特定功能的数据抓取
- **职责分离**: 抓取器不负责业务逻辑计算，只负责数据获取和返回
- **标准化接口**: 所有抓取器遵循统一的接口规范

#### 🚨 **向后兼容性保证**
- **`logging_config.py`**: **重新创建**兼容性日志模块
  - 提供原有的 `xuanping_logger`、`setup_logging`、`get_logger` 接口
  - 内部重定向到新的RPA日志系统
  - 保持CLI模块的无缝迁移
- **已废弃的旧文件** (**已安全删除**):
  - ~~`models.py`~~ → 迁移到 `models/` 目录
  - ~~`config.py`~~ → 迁移到 `config/` 目录
  - ~~原 `logging_config.py`~~ → 重新创建兼容版本

#### 📊 其他核心组件
- **`excel_processor.py`**: Excel文件处理 *(保持不变)*
- **`task_control.py`**: 任务控制和状态管理 *(保持不变)*

### 🤖 RPA模块 (`rpa/`)
**职责**: 浏览器自动化和页面操作

#### 核心服务层
- **`browser_service.py`**: 精简版浏览器服务
  - 浏览器生命周期管理
  - 共享实例管理 (支持浏览器复用)
  - 页面导航和组件协调
  - 统一的配置管理和错误处理

#### 接口定义层 (`core/interfaces/`)
- **`browser_driver.py`**: 浏览器驱动抽象接口
- **`page_analyzer.py`**: 页面分析器接口
- **`paginator.py`**: 分页器接口

#### 实现层 (`implementations/`)
- **`playwright_browser_driver.py`**: Playwright浏览器驱动实现
- **`dom_page_analyzer.py`**: DOM页面分析器
- **`universal_paginator.py`**: 通用分页器

#### 配置和模型
- **`core/config/`**: 浏览器服务配置管理
- **`core/models/`**: 页面元素和浏览器状态模型
- **`core/exceptions/`**: 浏览器相关异常定义

#### 架构和编码规范
- **参考文档**: [`rpa/docs/browser_architecture_and_coding_standards.md`](../rpa/docs/browser_architecture_and_coding_standards.md)
  - 定义了浏览器服务模块的架构设计规范
  - 制定了统一的编码标准和最佳实践
  - 包含完整的设计模式、错误处理、跨平台兼容性指南
  - 提供了技术债务清理计划和快速参考指南

### 🧪 Tests模块 (`tests/`)
**职责**: 测试套件和质量保证
- **单元测试**: 各组件的独立功能测试
- **集成测试**: 跨模块协作测试
- **性能测试**: 关键路径性能验证
- **真实场景测试**: 基于实际数据的端到端测试

## 模块依赖关系 - **重构后清晰分层架构**

```
┌─────────────────────────┐
│       CLI Layer         │ ← **应用层** (用户交互)
│   ┌─────────────────┐   │
│   │ CLI Config      │   │ • 命令解析和用户交互
│   │ Task Control    │   │ • 状态管理和进度跟踪
│   │ UI State Mgmt   │   │ • 配置预设管理
│   └─────────────────┘   │
└──────────┬──────────────┘
           │ 依赖 ↓
┌─────────────────────────┐
│      Common Layer       │ ← **核心业务层** (业务逻辑)
│                         │
│ ┌─────────────────────┐ │
│ │    Data Models      │ │ • 统一数据模型和枚举
│ │  Business|Scraping  │ │ • 业务实体和抓取结果
│ │    Excel|Exceptions │ │ • Excel处理和异常定义
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │   Config Manager    │ │ • 分层配置管理
│ │ Base|System|Business│ │ • 系统配置和业务配置
│ │   Platform Configs  │ │ • 平台选择器配置
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │    Utils & Tools    │ │ • 模型工具和抓取工具
│ │  Model|Scraping|Wait│ │ • 时序控制和数据处理
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │  Business Logic     │ │ • 价格计算和利润评估
│ │ Pricing|Profit|Store│ │ • 店铺评估和货源匹配
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │     Scrapers        │ │ • 平台特定的数据抓取
│ │ Seerfar|OZON|ERP    │ │ • 竞争对手和API数据
│ └─────────────────────┘ │
└──────────┬──────────────┘
           │ 依赖 ↓
┌─────────────────────────┐
│        RPA Layer        │ ← **基础设施层** (浏览器自动化)
│                         │
│ ┌─────────────────────┐ │
│ │  Browser Service    │ │ • 浏览器生命周期管理
│ │    Simplified       │ │ • 共享实例和配置管理
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │    Interfaces       │ │ • 抽象接口定义
│ │ Driver|Analyzer|    │ │ • 驱动、分析器、分页器
│ │    Paginator        │ │
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │  Implementations    │ │ • Playwright驱动实现
│ │ Playwright|DOM|     │ │ • DOM分析和通用分页
│ │   Universal         │ │
│ └─────────────────────┘ │
└──────────┬──────────────┘
           │ 通过 ↓
┌─────────────────────────┐
│    External Services    │ ← **外部依赖**
│                         │
│ • OZON平台 (商品数据)    │
│ • Seerfar API (销售数据) │
│ • ERP插件 (采购价格)     │
│ • 1688平台 (货源匹配)    │
│ • 汇率API (实时汇率)     │
└─────────────────────────┘
```

### 🔄 **架构优势**
- **清晰分层**: 应用层 → 业务层 → 基础层 → 外部服务
- **单向依赖**: 高层模块依赖低层模块，避免循环依赖
- **职责分离**: 每层专注特定职责，便于维护和扩展
- **模块化**: 内部模块按功能组织，支持独立开发和测试

### 数据流向
1. **CLI层**: 接收用户输入，管理任务状态
2. **Common层**: 执行核心业务逻辑，协调各个抓取器
3. **RPA层**: 提供浏览器自动化能力，支持页面操作
4. **外部服务**: 提供数据源和业务支持

### 关键设计原则
- **分层架构**: 清晰的职责分离，上层依赖下层
- **接口抽象**: 通过接口定义实现依赖倒置
- **配置驱动**: 通过配置对象管理系统行为
- **异步优先**: 网络IO和文件操作使用异步模式
- **错误隔离**: 单点故障不影响整体系统稳定性
- **避免过度设计**: **MUST** 避免过度设计，无若必要，勿增实体！遵循 YAGNI (You Aren't Gonna Need It) 原则，优先选择简洁明了的实现方案，避免不必要的抽象和复杂性

## 外部依赖
- **OZON网站**: 商品价格和跟卖信息的数据源
- **Seerfar API**: 店铺销售数据和分析报告
- **ERP插件服务**: 商品采购价格和供应链信息
- **1688平台**: 货源匹配和价格对比
- **汇率API**: 实时汇率转换服务
- **浏览器驱动**: ChromeDriver或其他WebDriver实现
